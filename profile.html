
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>會員資料</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header><button class="menu-toggle" onclick="toggleMenu()">☰</button><div class="logo">CC代購</div></header>
<nav id="mobile-nav"><a href="index.html">首頁</a><a href="services.html">服務介紹</a><a href="search.html">代購進度</a><a href="track.html">個人訂單查詢</a><a href="contact.html">聯絡我們</a><a href="admin.html">後台管理</a></nav>
<main>
  <h2>會員資料</h2>
  <form id="profile-form">
    <p><strong>帳號：</strong> <span id="username">（讀取中）</span></p>
    <label>姓名：</label><input type="text" id="name"><br>
    <label>Line：</label><input type="text" id="line"><br>
    <label>Facebook：</label><input type="text" id="facebook"><br>
    <label>Discord：</label><input type="text" id="discord"><br>
    <h3>變更密碼</h3>
    <label>舊密碼：</label><input type="password" id="old-password"><br>
    <label>新密碼：</label><input type="password" id="new-password"><br>
    <button type="submit">儲存變更</button>
  </form>
  <br>
  <button onclick="logout()">登出</button>
</main>
<script>
const client = supabase.createClient(
  "https://yulsvfryagetntqbxjgu.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1bHN2ZnJ5YWdldG50cWJ4amd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ0MzMxMDQsImV4cCI6MjA2MDAwOTEwNH0.7U9vaYirq_eRmmn-f47eht1i7oWhYW5RrYcQyEd0eLI"
);
let currentUser = null;

document.getElementById("profile-form").addEventListener("submit", async function (e) {
  e.preventDefault();
  const uid = currentUser.id;

  // 驗證舊密碼
  const email = currentUser.email;
  const oldPass = document.getElementById("old-password").value;
  const newPass = document.getElementById("new-password").value;
  if (oldPass && newPass) {
    const { error: loginErr } = await client.auth.signInWithPassword({ email, password: oldPass });
    if (loginErr) return alert("舊密碼錯誤！");
    const { error: pwErr } = await client.auth.updateUser({ password: newPass });
    if (pwErr) return alert("密碼變更失敗：" + pwErr.message);
  }

  // 更新使用者欄位
  const updates = {
    name: document.getElementById("name").value,
    line: document.getElementById("line").value,
    facebook: document.getElementById("facebook").value,
    discord: document.getElementById("discord").value,
  };
  const { error } = await client.from("users").update(updates).eq("id", uid);
  if (error) return alert("更新資料失敗：" + error.message);
  alert("資料已更新！");
});

async function loadProfile() {
  const { data: session } = await client.auth.getUser();
  if (!session.user) return (window.location.href = "track.html");
  currentUser = session.user;
  const account = currentUser.email.split("@")[0];
  document.getElementById("username").textContent = account;

  const { data } = await client.from("users").select("*").eq("id", currentUser.id).single();
  if (data) {
    document.getElementById("name").value = data.name || "";
    document.getElementById("line").value = data.line || "";
    document.getElementById("facebook").value = data.facebook || "";
    document.getElementById("discord").value = data.discord || "";
  }
}

function logout() {
  client.auth.signOut().then(() => window.location.href = "track.html");
}
function toggleMenu() {
  document.getElementById("mobile-nav").classList.toggle("show");
}
loadProfile();
</script>
</body>
</html>
